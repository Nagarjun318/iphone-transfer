name: Build and Deploy ClickOnce to Vercel

# WHY: Triggers on every push to main → auto-deploys new version
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # WHY: Allow manual trigger from GitHub UI

permissions:
  contents: write  # WHY: Needed to create GitHub Releases

jobs:
  build-and-deploy:
    runs-on: windows-latest  # WHY: WPF + ClickOnce only builds on Windows

    steps:
      # ── 1. Checkout code ──────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Install .NET 6 SDK ─────────────────────────────────────────────
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      # ── 3. Add MSBuild to PATH ────────────────────────────────────────────
      # WHY: msbuild is installed with Visual Studio on windows-latest but not
      #      in PATH by default. This action finds and exposes it.
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # ── 4. Restore NuGet packages ─────────────────────────────────────────
      - name: Restore dependencies
        run: dotnet restore src/iPhoneTransfer.UI/iPhoneTransfer.UI.csproj

      # ── 5. Extract version from tag or use default ────────────────────────
      # WHY: Lets you version releases by pushing a git tag like v1.2.3
      # WHY pwsh: windows-latest runner doesn't have bash; use PowerShell
      - name: Set version
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
            $VERSION = $Matches[1]
          } else {
            $VERSION = "1.0.0"
          }
          $FULL_VERSION = "${VERSION}.${{ github.run_number }}"
          echo "version=$FULL_VERSION" >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $FULL_VERSION"

      # ── 6. Publish ClickOnce ──────────────────────────────────────────────
      # WHY: msbuild /t:Publish generates the full ClickOnce deployment:
      #   - setup.exe  (bootstrapper installer)
      #   - Application Files/  (versioned app files)
      #   - iPhoneTransfer.application (ClickOnce manifest)
      # WHY absolute PublishDir: msbuild requires trailing backslash + full path
      - name: Publish ClickOnce
        shell: pwsh
        run: |
          $publishDir = "${{ github.workspace }}\clickonce-output\"
          $installUrl = "https://${{ secrets.VERCEL_PROJECT_URL }}/"
          $appVersion = "${{ steps.version.outputs.version }}"
          msbuild src/iPhoneTransfer.UI/iPhoneTransfer.UI.csproj `
            /t:Publish `
            /p:Configuration=Release `
            /p:Platform=x64 `
            "/p:PublishDir=$publishDir" `
            "/p:InstallUrl=$installUrl" `
            "/p:ApplicationVersion=$appVersion" `
            /p:IsWebBootstrapper=true `
            /p:UpdateEnabled=true `
            /p:UpdateMode=Foreground `
            /p:UpdateInterval=7 `
            /p:UpdateIntervalUnits=Days

      # ── 6a. Debug: List ClickOnce output ─────────────────────────────────
      - name: List ClickOnce output
        shell: pwsh
        run: |
          Write-Host "=== ClickOnce output directory ==="
          Get-ChildItem -Path clickonce-output -Recurse | Select-Object FullName, Length | Format-Table -AutoSize

      # ── 7. Create GitHub Release with setup.exe ────────────────────────
      # WHY: Vercel blocks .exe files. GitHub Releases serves binaries reliably.
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## iPhone Photo Transfer v${{ steps.version.outputs.version }}
            
            ### Download
            Download **iPhoneTransfer-Setup.exe** below to install.
            
            ### Requirements
            - Windows 10/11 (64-bit)
            - iTunes drivers (install iTunes once, then you can uninstall it)
          files: |
            clickonce-output/setup.exe
          make_latest: true

      # ── 8. Prepare Vercel deployment (landing page only) ──────────────────
      # WHY: Vercel serves the landing page; .exe download links to GitHub Releases
      - name: Prepare Vercel site
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path vercel-deploy
          
          # Copy landing page and config
          Copy-Item vercel-site/index.html vercel-deploy/index.html -Force
          Copy-Item vercel-site/vercel.json vercel-deploy/vercel.json -Force
          if (Test-Path vercel-site/public) {
            Copy-Item vercel-site/public/* vercel-deploy/ -Recurse -Force
          }

          # WHY: Inject version, date, and GitHub release download URL
          $html = Get-Content vercel-deploy/index.html -Raw
          $html = $html -replace '__VERSION__', '${{ steps.version.outputs.version }}'
          $html = $html -replace '__BUILD_DATE__', (Get-Date -Format 'MMMM d, yyyy')
          $html = $html -replace '__SETUP_EXE_URL__', 'https://github.com/Nagarjun318/iphone-transfer/releases/latest/download/setup.exe'
          Set-Content vercel-deploy/index.html $html

      # ── 9. Deploy landing page to Vercel ──────────────────────────────────
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: vercel-deploy
          vercel-args: '--prod'

      # ── 10. Upload artifacts for debugging ───────────────────────────────
      - name: Upload ClickOnce artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clickonce-${{ steps.version.outputs.version }}
          path: clickonce-output/
          retention-days: 30
