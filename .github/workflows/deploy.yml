name: Build and Deploy ClickOnce to Vercel

# WHY: Triggers on every push to main → auto-deploys new version
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # WHY: Allow manual trigger from GitHub UI

permissions:
  contents: write  # WHY: Needed to create GitHub Releases

jobs:
  build-and-deploy:
    runs-on: windows-latest  # WHY: WPF + ClickOnce only builds on Windows

    steps:
      # ── 1. Checkout code ──────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Install .NET 6 SDK ─────────────────────────────────────────────
      - name: Setup .NET 6
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x'

      # ── 3. Restore NuGet packages ─────────────────────────────────────────
      - name: Restore dependencies
        run: dotnet restore src/iPhoneTransfer.UI/iPhoneTransfer.UI.csproj -r win-x64

      # ── 5. Extract version from tag or use default ────────────────────────
      # WHY: Lets you version releases by pushing a git tag like v1.2.3
      # WHY pwsh: windows-latest runner doesn't have bash; use PowerShell
      - name: Set version
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
            $VERSION = $Matches[1]
          } else {
            $VERSION = "1.0.0"
          }
          $FULL_VERSION = "${VERSION}.${{ github.run_number }}"
          echo "version=$FULL_VERSION" >> $env:GITHUB_OUTPUT
          Write-Host "Building version: $FULL_VERSION"

      # ── 6. Build self-contained app for GitHub Release ─────────────────
      # WHY: dotnet publish produces a portable, self-contained app bundle
      #      that works without requiring .NET runtime on the user's machine.
      #      ClickOnce setup.exe is unreliable with SDK-style projects.
      - name: Publish self-contained app
        shell: pwsh
        run: |
          dotnet publish src/iPhoneTransfer.UI/iPhoneTransfer.UI.csproj `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=true `
            -p:IncludeNativeLibrariesForSelfExtract=true `
            -p:IncludeAllContentForSelfExtract=true `
            -p:Version=${{ steps.version.outputs.version }} `
            -o publish-output

      # ── 6a. Create installer zip ─────────────────────────────────────────
      - name: Package release
        shell: pwsh
        run: |
          # Rename the main exe for clarity
          $exePath = Get-ChildItem publish-output -Filter "iPhoneTransfer.exe" | Select-Object -First 1
          if ($exePath) {
            Write-Host "✅ Found: $($exePath.FullName) ($($exePath.Length) bytes)"
          } else {
            Write-Host "Contents of publish-output:"
            Get-ChildItem publish-output -Recurse | Select-Object FullName, Length | Format-Table -AutoSize
            Write-Host "❌ iPhoneTransfer.exe not found"
            exit 1
          }
          
          # Create a zip for the release
          Compress-Archive -Path publish-output\* -DestinationPath "iPhoneTransfer-v${{ steps.version.outputs.version }}-win-x64.zip"
          Write-Host "✅ Created zip: iPhoneTransfer-v${{ steps.version.outputs.version }}-win-x64.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## iPhone Photo Transfer v${{ steps.version.outputs.version }}
            
            ### Download
            Download the zip, extract, and run **iPhoneTransfer.exe**.
            
            ### Requirements
            - Windows 10/11 (64-bit)
            - iTunes drivers (install iTunes once, then you can uninstall it)
            
            ### What's included
            Self-contained app — no .NET runtime needed.
          files: iPhoneTransfer-v${{ steps.version.outputs.version }}-win-x64.zip
          make_latest: true
          fail_on_unmatched_files: true

      # ── 8. Prepare Vercel deployment (landing page only) ──────────────────
      # WHY: Vercel serves the landing page; .exe download links to GitHub Releases
      - name: Prepare Vercel site
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path vercel-deploy
          
          # Copy landing page and config
          Copy-Item vercel-site/index.html vercel-deploy/index.html -Force
          Copy-Item vercel-site/vercel.json vercel-deploy/vercel.json -Force
          if (Test-Path vercel-site/public) {
            Copy-Item vercel-site/public/* vercel-deploy/ -Recurse -Force
          }

          # WHY: Inject version, date, and GitHub release download URL
          $html = Get-Content vercel-deploy/index.html -Raw
          $html = $html -replace '__VERSION__', '${{ steps.version.outputs.version }}'
          $html = $html -replace '__BUILD_DATE__', (Get-Date -Format 'MMMM d, yyyy')
          $html = $html -replace '__SETUP_EXE_URL__', 'https://github.com/Nagarjun318/iphone-transfer/releases/latest/download/iPhoneTransfer-v${{ steps.version.outputs.version }}-win-x64.zip'
          Set-Content vercel-deploy/index.html $html

      # ── 9. Deploy landing page to Vercel ──────────────────────────────────
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: vercel-deploy
          vercel-args: '--prod'

      # ── 10. Upload artifacts for debugging ───────────────────────────────
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: iPhoneTransfer-${{ steps.version.outputs.version }}
          path: publish-output/
          retention-days: 30
